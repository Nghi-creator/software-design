{{#section "css"}}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<!-- Uppy CSS -->
<link href="https://releases.transloadit.com/uppy/v5.2.0/uppy.min.css" rel="stylesheet">
<!-- Admin Shared + Page-specific CSS -->
<link rel="stylesheet" href="/static/css/admin/shared.css">
<link rel="stylesheet" href="/static/css/admin/products/add.css">
{{/section}}

<div class="container-fluid mt-4 mb-5">
  <div class="row">

    {{!-- LEFT SIDEBAR --}}
    <div class="col-lg-3 mb-4">
      {{> admin-sidebar activeSection='products'}}
    </div>

    {{!-- RIGHT CONTENT --}}
    <div class="col-lg-9">

      {{!-- HEADER --}}
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="display-6 text-dark mb-1">Edit {{product.name}}</h2>
          <p class="text-muted">Modify the details of this auction product below.</p>
        </div>
        <a href="/admin/products/list" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to list products
        </a>
      </div>

      {{> alerts}}

      {{!-- FORM --}}
      <form id="addProductForm" method="POST" action="/admin/products/edit" enctype="application/x-www-form-urlencoded">
        <input type="hidden" name="id" value="{{product.id}}">

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header card-header-admin">
            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h5>
          </div>
          <div class="card-body">

            {{!-- Product Name --}}
            <div class="mb-3">
              <label for="productName" class="form-label required">Product Name</label>
              <input type="text" class="form-control" id="productName" name="name" maxlength="255"
                value="{{product.name}}">
              <div class="invalid-feedback" id="productNameError">Please enter a product name.</div>
            </div>

            {{!-- Category --}}
            <div class="mb-3">
              <label for="category" class="form-label required">Category</label>
              <select class="form-select" id="category" name="category_id">
                <option value="">Select a category</option>
                {{#each lcCategories1}}
                <option value="{{this.id}}" {{#if (eq this.id ../product.category_id)}}selected{{/if}}>{{this.name}}
                </option>
                {{/each}}
                {{#each lcCategories2}}
                <option value="{{this.id}}" {{#if (eq this.id ../product.category_id)}}selected{{/if}}>{{this.name}}
                </option>
                {{/each}}
              </select>
              <div class="invalid-feedback" id="categoryError">Please select a category.</div>
            </div>

            {{!-- Description --}}
            <div class="mb-3">
              <label for="description" class="form-label">Product Description</label>
              <div id="editor-container">{{{product.description}}}</div>
              <input type="hidden" name="description" id="descriptionInput" value="">
              <div class="invalid-feedback" id="descriptionError">Please enter a product description.</div>
            </div>

          </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header card-header-admin">
            <h5 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>Pricing & Duration</h5>
          </div>
          <div class="card-body">

            {{!-- Starting Price --}}
            <div class="mb-3">
              <label for="startingPrice" class="form-label required">Starting Price (VND)</label>
              <input class="form-control" id="startingPrice" name="starting_price" value="{{product.starting_price}}">
              <div class="invalid-feedback" id="startPriceError">Please enter a valid starting price (minimum 1,000
                VND).</div>
            </div>

            {{!-- Step Price --}}
            <div class="mb-3">
              <label for="stepPrice" class="form-label required">Bid Step (VND)</label>
              <input class="form-control" id="stepPrice" name="step_price" value="{{product.step_price}}">
              <small class="form-text text-muted">Minimum amount each bid must increase.</small>
              <div class="invalid-feedback" id="stepPriceError">Please enter a valid bid step (minimum 1,000 VND).</div>
            </div>
            {{!-- Buy Now Price --}}
            <div class="mb-3">
              <label for="buyNowPrice" class="form-label">Buy Now Price (VND) - Optional</label>
              <input class="form-control" id="buyNowPrice" name="buy_now_price" value="{{product.buy_now_price}}">
              <small class="form-text text-muted">Leave empty if you don't want to enable "Buy Now" option.</small>
              <div class="invalid-feedback" id="buyNowPriceError">Buy now price must be greater than starting price.
              </div>
            </div>

            {{!-- Auction End Date/Time --}}
            <div class="mb-3">
              <label for="endDate" class="form-label required">Auction End Date/Time</label>
              <input type="datetime-local" class="form-control" id="endDate" name="end_date_display"
                style="max-width: 300px;" value="{{format_date_input product.end_date}}">
              <input type="hidden" id="endDateFormatted" name="end_date" value="{{product.end_date}}">
              <div class="invalid-feedback" id="endDateError" style="display: none;">Please select a valid end date and
                time.</div>
            </div>

            {{!-- Created At (Hidden) --}}
            <input type="hidden" id="createdAt" name="created_at">

          </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header card-header-admin">
            <h5 class="mb-0"><i class="bi bi-images me-2"></i>Product Images</h5>
          </div>
          <div class="card-body">

            {{!-- Main Thumbnail --}}
            <div class="mb-4">
              <label class="form-label required">Main Thumbnail (1 image)</label>
              {{#if product.thumbnail}}
              <div class="mb-2">
                <p class="text-muted small">Current thumbnail:</p>
                <img src="/static/images/products/{{product.thumbnail}}" alt="Current thumbnail" class="img-thumbnail"
                  style="max-width: 200px;">
              </div>
              {{/if}}
              <div id="uppy-thumbnail"></div>
              <div class="invalid-feedback" id="thumbnailError">Please upload a main thumbnail image.</div>
              <small class="form-text text-muted d-block mt-2">
                <i class="bi bi-info-circle"></i> {{#if product.thumbnail}}Upload a new image to replace the current
                one, or leave empty to keep the current thumbnail.{{else}}This will be the primary image displayed for
                your product.{{/if}}
              </small>
              <input type="hidden" name="thumbnail" id="txt_thumbnail" value="{{product.thumbnail}}">
            </div>

            <hr class="my-4">

            {{!-- Sub Images --}}
            <div class="mb-3">
              <label class="form-label required">Additional Images (Minimum 3 images)</label>
              {{#if product.imgs_list}}
              <div class="mb-2">
                <p class="text-muted small">Current images:</p>
                <div class="d-flex flex-wrap gap-2">
                  {{#each product.imgs_list}}
                  <img src="/static/images/products/{{this}}" alt="Product image" class="img-thumbnail"
                    style="max-width: 100px;">
                  {{/each}}
                </div>
              </div>
              {{/if}}
              <div id="uppy-subimages"></div>
              <div class="invalid-feedback" id="subImagesError">Please upload at least 3 additional images.</div>
              <small class="form-text text-muted d-block mt-2">
                <i class="bi bi-info-circle"></i> {{#if product.imgs_list}}Upload new images to replace current ones, or
                leave empty to keep them.{{else}}These images will be shown in the product gallery.{{/if}}
              </small>
              <input type="hidden" name="imgs_list" id="txt_imgs_list"
                value="{{#if product.imgs_list}}{{product.imgs_list}}{{/if}}">
            </div>

          </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header card-header-admin">
            <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Auction Settings</h5>
          </div>
          <div class="card-body">

            {{!-- Auto-extend --}}
            <div class="mb-3">
              <input type="hidden" name="auto_extend" value="0">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoExtend" name="auto_extend" value="1" {{#if
                  product.auto_extend}}checked{{/if}}>
                <label class="form-check-label" for="autoExtend">
                  <strong>Enable Auto-extend</strong>
                  <small class="d-block text-muted">
                    If a bid is placed within the last 5 minutes before the auction ends, automatically extend the
                    auction by 10 minutes.
                  </small>
                </label>
              </div>
            </div>

            {{!-- Allow New Bidders --}}
            <div class="mb-3">
              <input type="hidden" name="allow_new_bidders" value="0">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="allowNewBidders" name="allow_new_bidders" value="1"
                  {{#if product.allow_new_bidders}}checked{{/if}}>
                <label class="form-check-label" for="allowNewBidders">
                  <strong>Allow New Bidders</strong>
                  <small class="d-block text-muted">
                    Allow bidders who have never won an auction to participate in this auction.
                  </small>
                </label>
              </div>
            </div>

          </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header card-header-admin">
            <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Seller Assignment</h5>
          </div>
          <div class="card-body">

            {{!-- Seller Selection --}}
            <div class="mb-3">
              <label for="seller" class="form-label required">Assign to Seller</label>
              <select class="form-select" id="seller" name="seller_id">
                <option value="">Select a seller</option>
                {{#each sellers}}
                <option value="{{this.id}}" {{#if (eq this.id ../product.seller_id)}}selected{{/if}}>
                  {{this.fullname}} ({{this.email}})
                  {{#if this.products_count}}
                  - {{this.products_count}} products
                  {{/if}}
                </option>
                {{/each}}
              </select>
              <div class="invalid-feedback" id="sellerError">Please select a seller for this product.</div>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle"></i> Choose which seller account will own this product.
              </small>
            </div>

          </div>
        </div>

        {{!-- Submit Buttons --}}
        <div class="d-flex gap-2 mb-4">
          <button type="submit" class="btn btn-lg px-5 btn-admin-primary">
            <i class="bi bi-check-circle me-2"></i>Update Product
          </button>
          <a href="/admin/products/list" class="btn btn-outline-secondary btn-lg px-4 btn-admin-secondary">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </a>
        </div>

      </form>

    </div>
  </div>
</div>

{{#section "js"}}
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
<script src="/static/js/admin/product.js"></script>
<script>
  window.__productFormConfig = {
    uploadThumbnailEndpoint: '/seller/products/upload-thumbnail',
    uploadSubimagesEndpoint: '/seller/products/upload-subimages',
    initialThumbnail: '{{product.thumbnail}}',
    initialSubImgs: [{{ #each product.imgs_list }}"{{this}}"{ { #unless @last } }, { { /unless}}{{/each } }],
  initialDescription: '{{{product.description}}}',
    formId: 'addProductForm',
      startPriceId: 'startingPrice'
  };
  new Cleave('#startingPrice', { numeral: true, numeralThousandsGroupStyle: 'thousand' });
  new Cleave('#stepPrice', { numeral: true, numeralThousandsGroupStyle: 'thousand' });
  new Cleave('#buyNowPrice', { numeral: true, numeralThousandsGroupStyle: 'thousand' });
</script>
<script type="module" src="/static/js/admin/product-form.mjs"></script>
{{/section}}