{{#section 'css'}}
<link rel="stylesheet" href="/static/css/product/order.css">
{{/section}}
{{/section}}

<div class="container my-5">
  {{> alerts}}
  <div class="row">
    <div class="col-12">
      <div class="d-flex align-items-center mb-4">
        <a href="/products/detail?id={{product.id}}" class="btn btn-outline-secondary me-3">
          <i class="bi bi-arrow-left"></i>
        </a>
        <h2 class="mb-0"><i class="bi bi-receipt"></i> Complete Order</h2>
      </div>
    </div>
  </div>

  <div class="row g-4 order-content-row">

    {{!-- Left Column: Timeline + Info --}}
    <div class="col-lg-8" id="leftColumn">

      {{!-- Product Info Card --}}
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3"><i class="bi bi-box-seam"></i> Product Information</h5>
          <div class="row align-items-center">
            <div class="col-md-3">
              <img src="/static/{{product.thumbnail}}" class="img-fluid rounded" alt="{{product.name}}"
                style="max-height: 150px; object-fit: cover;">
            </div>
            <div class="col-md-9">
              <h6 class="mb-2">{{product.name}}</h6>
              <p class="mb-1 text-muted"><small><i class="bi bi-tag"></i> {{product.category_name}}</small></p>
              <p class="mb-1"><strong>Final Price:</strong> <span class="text-success fs-5">{{format_number
                  product.current_price}} VNĐ</span></p>
              <p class="mb-0"><small class="text-muted"><i class="bi bi-clock"></i> Ended: {{format_date
                  product.end_at}}</small></p>
            </div>
          </div>
        </div>
      </div>

      {{!-- Buyer & Seller Info --}}
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="card-title"><i class="bi bi-person-circle"></i> Bidder</h6>
              <p class="mb-1"><strong>Name:</strong> {{product.highest_bidder_name}}</p>
              <p class="mb-0"><strong>Email:</strong> {{product.highest_bidder_email}}</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h6 class="card-title"><i class="bi bi-shop"></i> Seller</h6>
              <p class="mb-1"><strong>Name:</strong> {{product.seller_name}}</p>
              <p class="mb-0"><strong>Email:</strong> {{product.seller_email}}</p>
            </div>
          </div>
        </div>
      </div>

      {{!-- Timeline --}}
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title mb-4"><i class="bi bi-diagram-3"></i> Order Progress</h5>

          <div class="timeline">

            {{!-- Step 1: Payment --}}
            <div
              class="timeline-item {{#if (eq order.status 'pending_payment')}}active{{/if}} {{#if (eq order.status 'payment_submitted')}}completed{{/if}} {{#if (eq order.status 'payment_confirmed')}}completed{{/if}} {{#if (eq order.status 'shipped')}}completed{{/if}} {{#if (eq order.status 'delivered')}}completed{{/if}} {{#if (eq order.status 'completed')}}completed{{/if}}">
              <div class="timeline-icon">
                <i class="bi bi-credit-card"></i>
              </div>
              <div class="timeline-line"></div>
              <div class="timeline-content">
                <h6>Step 1: Payment</h6>
                <p class="text-muted mb-0">
                  {{#if (eq order.status 'pending_payment')}}
                  <span class="badge bg-warning text-dark">Waiting for bidder payment</span>
                  {{else}}
                  <span class="badge bg-success">Paid</span>
                  {{/if}}
                </p>
              </div>
            </div>

            {{!-- Step 2: Payment Confirmation --}}
            <div
              class="timeline-item {{#if (eq order.status 'payment_submitted')}}active{{/if}} {{#if (eq order.status 'payment_confirmed')}}completed{{/if}} {{#if (eq order.status 'shipped')}}completed{{/if}} {{#if (eq order.status 'delivered')}}completed{{/if}} {{#if (eq order.status 'completed')}}completed{{/if}}">
              <div class="timeline-icon">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="timeline-line"></div>
              <div class="timeline-content">
                <h6>Step 2: Payment Confirmation</h6>
                <p class="text-muted mb-0">
                  {{#if (eq order.status 'payment_submitted')}}
                  <span class="badge bg-warning text-dark">Waiting for seller confirmation</span>
                  {{else if (eq order.status 'payment_confirmed')}}
                  <span class="badge bg-success">Confirmed</span>
                  {{else if (eq order.status 'shipped')}}
                  <span class="badge bg-success">Confirmed</span>
                  {{else if (eq order.status 'delivered')}}
                  <span class="badge bg-success">Confirmed</span>
                  {{else if (eq order.status 'completed')}}
                  <span class="badge bg-success">Confirmed</span>
                  {{else}}
                  <span class="badge bg-secondary">Not started</span>
                  {{/if}}
                </p>
              </div>
            </div>

            {{!-- Step 3: Shipping --}}
            <div
              class="timeline-item {{#if (eq order.status 'payment_confirmed')}}active{{/if}} {{#if (eq order.status 'shipped')}}completed{{/if}} {{#if (eq order.status 'delivered')}}completed{{/if}} {{#if (eq order.status 'completed')}}completed{{/if}}">
              <div class="timeline-icon">
                <i class="bi bi-truck"></i>
              </div>
              <div class="timeline-line"></div>
              <div class="timeline-content">
                <h6>Step 3: Shipping</h6>
                <p class="text-muted mb-0">
                  {{#if (eq order.status 'payment_confirmed')}}
                  <span class="badge bg-warning text-dark">Waiting for seller to ship</span>
                  {{else if (eq order.status 'shipped')}}
                  <span class="badge bg-success">In delivery</span>
                  {{else if (eq order.status 'delivered')}}
                  <span class="badge bg-success">Delivered</span>
                  {{else if (eq order.status 'completed')}}
                  <span class="badge bg-success">Delivered</span>
                  {{else}}
                  <span class="badge bg-secondary">Not started</span>
                  {{/if}}
                </p>
              </div>
            </div>

            {{!-- Step 4: Delivery Confirmation --}}
            <div
              class="timeline-item {{#if (eq order.status 'shipped')}}active{{/if}} {{#if (eq order.status 'delivered')}}completed{{/if}} {{#if (eq order.status 'completed')}}completed{{/if}}">
              <div class="timeline-icon">
                <i class="bi bi-house-check"></i>
              </div>
              <div class="timeline-line"></div>
              <div class="timeline-content">
                <h6>Step 4: Delivery Confirmation</h6>
                <p class="text-muted mb-0">
                  {{#if (eq order.status 'shipped')}}
                  <span class="badge bg-warning text-dark">Waiting for bidder confirmation</span>
                  {{else if (eq order.status 'delivered')}}
                  <span class="badge bg-success">Received</span>
                  {{else if (eq order.status 'completed')}}
                  <span class="badge bg-success">Received</span>
                  {{else}}
                  <span class="badge bg-secondary">Not started</span>
                  {{/if}}
                </p>
              </div>
            </div>

            {{!-- Step 5: Rating --}}
            <div
              class="timeline-item {{#if (eq order.status 'delivered')}}active{{/if}} {{#if (eq order.status 'completed')}}completed{{/if}}">
              <div class="timeline-icon">
                <i class="bi bi-star"></i>
              </div>
              <div class="timeline-content">
                <h6>Step 5: Rating</h6>
                <p class="text-muted mb-0">
                  {{#if (eq order.status 'delivered')}}
                  <span class="badge bg-warning text-dark">Waiting for rating</span>
                  {{else if (eq order.status 'completed')}}
                  <span class="badge bg-success">Completed</span>
                  {{else}}
                  <span class="badge bg-secondary">Not started</span>
                  {{/if}}
                </p>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>

    {{!-- Right Column: Actions --}}
    <div class="col-lg-4">

      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3"><i class="bi bi-gear-fill"></i> Actions</h5>

          {{#if isHighestBidder}}

          {{!-- Bidder: Payment submission --}}
          {{#if (eq order.status "pending_payment")}}
          <div class="alert alert-warning">
            <strong><i class="bi bi-exclamation-triangle"></i> Next Step:</strong>
            Please submit payment proof with shipping address.
          </div>
          <button type="button" class="btn btn-lg btn-success w-100 mb-2" data-bs-toggle="modal"
            data-bs-target="#paymentModal">
            <i class="bi bi-credit-card"></i> Submit Payment Proof
          </button>

          {{!-- Bidder: Waiting for seller confirmation --}}
          {{else if (eq order.status "payment_submitted")}}
          <div class="alert alert-info">
            <strong><i class="bi bi-info-circle"></i> Payment Submitted!</strong>
            Waiting for seller to confirm receipt of payment.
          </div>
          <div class="card bg-light">
            <div class="card-body">
              <h6>Submitted Information:</h6>
              <p class="mb-1"><strong>Payment Method:</strong> <span style="text-transform: capitalize;">{{replace
                  paymentInvoice.payment_method "_" " "}}</span></p>
              <p class="mb-1"><strong>Address:</strong> {{order.shipping_address}}</p>
              <p class="mb-0"><strong>Phone:</strong> {{order.shipping_phone}}</p>
            </div>
          </div>

          {{!-- Bidder: Waiting for shipment --}}
          {{else if (eq order.status "payment_confirmed")}}
          <div class="alert alert-success">
            <strong><i class="bi bi-check-circle"></i> Payment Confirmed!</strong>
            Waiting for seller to ship the item.
          </div>

          {{!-- Bidder: Confirm delivery --}}
          {{else if (eq order.status "shipped")}}
          <div class="alert alert-warning">
            <strong><i class="bi bi-truck"></i> Item In Transit!</strong>
            Tracking number: <code>{{shippingInvoice.tracking_number}}</code>
            {{#if shippingInvoice.shipping_provider}}
            <br>Shipping provider: {{shippingInvoice.shipping_provider}}
            {{/if}}
          </div>

          {{#if shippingInvoice.shipping_proof_urls}}
          <div class="mb-3">
            <strong>Shipping Proof Images:</strong>
            <div class="row g-2 mt-1">
              {{#each shippingInvoice.shipping_proof_urls}}
              <div class="col-6 col-md-4">
                <img src="/static/{{this}}" class="img-thumbnail" alt="Shipping proof"
                  style="max-height: 150px; width: 100%; object-fit: cover; cursor: pointer;"
                  onclick="showImageModal('/static/{{this}}')">
              </div>
              {{/each}}
            </div>
          </div>
          {{/if}}

          <button type="button" class="btn btn-lg btn-success w-100 mb-2" onclick="confirmDelivery()">
            <i class="bi bi-check-circle"></i> Confirm Receipt
          </button>

          {{!-- Buyer: Rate transaction --}}
          {{else if (eq order.status "delivered")}}
          <div class="alert alert-info">
            <strong><i class="bi bi-star"></i> Order Received!</strong>
            Please rate this transaction to complete.
          </div>
          <button type="button" class="btn btn-lg btn-primary w-100 mb-2" onclick="submitRating()">
            <i class="bi bi-star-fill"></i> Rate Seller
          </button>

          {{!-- Buyer: Completed --}}
          {{else if (eq order.status "completed")}}
          <div class="alert alert-success">
            <strong><i class="bi bi-check-circle-fill"></i> Order Completed!</strong>
            Thank you for using our service.
          </div>
          {{/if}}

          {{/if}}

          {{#if isSeller}}

          {{!-- Seller: Waiting for payment --}}
          {{#if (eq order.status "pending_payment")}}
          <div class="alert alert-info">
            <strong><i class="bi bi-info-circle"></i> Waiting:</strong>
            Bidder submits payment proof.
          </div>

          {{!-- Seller: Confirm payment --}}
          {{else if (eq order.status "payment_submitted")}}
          <div class="alert alert-warning">
            <strong><i class="bi bi-exclamation-triangle"></i> Next Step:</strong>
            Confirm receipt of payment from bidder.
          </div>
          <div class="card bg-light mb-3">
            <div class="card-body">
              <h6>Payment Information from Bidder:</h6>
              <p class="mb-1"><strong>Payment Method:</strong> <span style="text-transform: capitalize;">{{replace
                  paymentInvoice.payment_method "_" " "}}</span></p>
              <p class="mb-1"><strong>Note:</strong> {{paymentInvoice.note}}</p>
              {{#if paymentInvoice.payment_proof_urls}}
              <div class="mt-2">
                <strong>Payment Proof:</strong>
                <div class="row g-2 mt-1">
                  {{#each paymentInvoice.payment_proof_urls}}
                  <div class="col-4">
                    <img src="/static/{{this}}" class="img-thumbnail payment-proof-img" alt="Payment proof"
                      style="width: 100%; height: 80px; object-fit: cover; cursor: pointer;"
                      onclick="showImageModal('/static/{{this}}')">
                  </div>
                  {{/each}}
                </div>
              </div>
              {{/if}}
              <p class="mb-1 mt-2"><strong>Shipping Address:</strong> {{order.shipping_address}}</p>
              <p class="mb-0"><strong>Phone:</strong> {{order.shipping_phone}}</p>
            </div>
          </div>
          <button type="button" class="btn btn-lg btn-success w-100 mb-2" onclick="confirmPayment()">
            <i class="bi bi-check-circle"></i> Confirm Payment Received
          </button>

          {{!-- Seller: Submit shipping --}}
          {{else if (eq order.status "payment_confirmed")}}
          <div class="alert alert-warning">
            <strong><i class="bi bi-exclamation-triangle"></i> Next Step:</strong>
            Ship the item and update tracking number.
          </div>
          <button type="button" class="btn btn-lg btn-primary w-100 mb-2" data-bs-toggle="modal"
            data-bs-target="#shippingModal">
            <i class="bi bi-truck"></i> Update Shipping Info
          </button>

          {{!-- Seller: Waiting for delivery confirmation --}}
          {{else if (eq order.status "shipped")}}
          <div class="alert alert-info">
            <strong><i class="bi bi-truck"></i> Item Shipped!</strong>
            Tracking number: <code>{{shippingInvoice.tracking_number}}</code>
            <br>Waiting for bidder to confirm receipt.
          </div>

          {{!-- Seller: Rate transaction --}}
          {{else if (eq order.status "delivered")}}
          <div class="alert alert-info">
            <strong><i class="bi bi-star"></i> Buyer Received Order!</strong>
            Please rate this transaction to complete.
          </div>
          <button type="button" class="btn btn-lg btn-primary w-100 mb-2" onclick="submitRating()">
            <i class="bi bi-star-fill"></i> Rate Bidder
          </button>

          {{!-- Seller: Completed --}}
          {{else if (eq order.status "completed")}}
          <div class="alert alert-success">
            <strong><i class="bi bi-check-circle-fill"></i> Order Completed!</strong>
            Thank you for using our service.
          </div>
          {{/if}}

          {{/if}}

          <div class="mt-3">
            <a href="/products/detail?id={{product.id}}" class="btn btn-outline-secondary w-100">
              <i class="bi bi-arrow-left"></i> Back to Product
            </a>
          </div>

        </div>
      </div>

    </div>

  </div>
</div>

{{!-- Chat Widget --}}
<div class="chat-widget minimized" id="chatWidget">
  <div class="chat-header" onclick="toggleChat()">
    <span><i class="bi bi-chat-dots"></i> Chat with {{#if isSeller}}Bidder{{else}}Seller{{/if}}</span>
    <button class="chat-toggle-btn" id="chatToggleBtn">
      <i class="bi bi-chevron-up"></i>
    </button>
  </div>
  <div class="chat-messages" id="chatMessages">
    {{#each messages}}
    <div class="chat-message {{#if (eq sender_id ../currentUserId)}}text-end{{/if}}">
      <div class="chat-bubble {{#if (eq sender_id ../currentUserId)}}sent{{else}}received{{/if}}">
        <div>{{message}}</div>
        <div style="font-size: 0.7rem; margin-top: 3px; opacity: 0.8;">{{format_date created_at}}</div>
      </div>
    </div>
    {{/each}}
  </div>
  <div class="chat-input">
    <div class="input-group">
      <input type="text" class="form-control" id="chatInput" placeholder="Type a message..."
        onkeypress="if(event.key==='Enter') sendChatMessage()">
      <button class="btn btn-primary" onclick="sendChatMessage()">
        <i class="bi bi-send"></i>
      </button>
    </div>
  </div>
</div>

{{!-- Payment Modal (Buyer) --}}
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-credit-card"></i> Submit Payment Proof</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="paymentForm" onsubmit="submitPayment(event)">
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Payment Amount</label>
            <input type="text" class="form-control-plaintext fw-bold text-success"
              value="{{format_number product.current_price}} VNĐ" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Payment Method <span class="text-danger">*</span></label>
            <select class="form-select" name="payment_method" id="paymentMethod">
              <option value="">-- Select method --</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="momo">MoMo Wallet</option>
              <option value="zalopay">ZaloPay</option>
              <option value="cash">Cash</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Payment Proof <span class="text-danger">*</span></label>
            <input type="file" class="form-control" id="paymentProofInput" accept="image/*" multiple>
            <div class="form-text">Select 1-3 images (JPG, PNG). Each &lt; 5MB</div>
            <div id="paymentProofPreview" class="mt-3 row g-2"></div>
          </div>

          <div class="mb-3">
            <label class="form-label">Note</label>
            <textarea class="form-control" name="note" rows="2"
              placeholder="E.g.: Transferred at 14:30 on 04/01/2026"></textarea>
          </div>

          <hr>
          <h6 class="mb-3"><i class="bi bi-geo-alt"></i> Shipping Address</h6>

          <div class="mb-3">
            <label class="form-label">Delivery Address <span class="text-danger">*</span></label>
            <textarea class="form-control" name="shipping_address" id="shippingAddress" rows="2"
              placeholder="Street, Ward, District, City"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Phone Number <span class="text-danger">*</span></label>
            <input type="tel" class="form-control" name="shipping_phone" id="shippingPhone" placeholder="0901234567">
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success" id="submitPaymentBtn">
            <i class="bi bi-send"></i> Submit Payment Proof
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{{!-- Shipping Modal (Seller) --}}
<div class="modal fade" id="shippingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-truck"></i> Update Shipping Information</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="shippingForm" onsubmit="submitShipping(event)">
        <div class="modal-body">

          <div class="alert alert-info">
            <strong>Ship to:</strong><br>
            {{order.shipping_address}}<br>
            <strong>Phone:</strong> {{order.shipping_phone}}
          </div>

          <div class="mb-3">
            <label class="form-label">Tracking Number <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="tracking_number" id="trackingNumber"
              placeholder="E.g.: GHTK123456789">
          </div>

          <div class="mb-3">
            <label class="form-label">Shipping Provider <span class="text-danger">*</span></label>
            <select class="form-select" name="shipping_provider" id="shippingProvider">
              <option value="">-- Select provider --</option>
              <option value="Giao hàng tiết kiệm">Giao hàng tiết kiệm (GHTK)</option>
              <option value="Giao hàng nhanh">Giao hàng nhanh (GHN)</option>
              <option value="J&T Express">J&T Express</option>
              <option value="Viettel Post">Viettel Post</option>
              <option value="VNPost">VNPost</option>
              <option value="Grab Express">Grab Express</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Shipping Receipt (optional)</label>
            <input type="file" class="form-control" id="shippingProofInput" accept="image/*" multiple>
            <div class="form-text">Upload 0-2 receipt images (optional)</div>
            <div id="shippingProofPreview" class="mt-3 row g-2"></div>
          </div>

          <div class="mb-3">
            <label class="form-label">Note</label>
            <textarea class="form-control" name="note" rows="2"
              placeholder="E.g.: Fragile item, handle with care"></textarea>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" id="submitShippingBtn">
            <i class="bi bi-truck"></i> Update Shipping
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{{!-- Rating Modal removed - using SweetAlert2 instead --}}

{{#section 'js'}}
<script src="/static/js/product/order.js"></script>
<script src="/static/js/product/order-forms.js"></script>
<script src="/static/js/product/order-chat.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const orderId = '{{order.id}}';

    // 1. Init Status Actions
    initOrderActions(orderId);

    // 2. Init Forms & Previews
    initOrderForms(orderId);

    // 3. Init Chat Widget
    initOrderChat(orderId);
  });
</script>
{{/section}}

<!-- Image Modal (Standardized) -->
<div id="imageModal" class="order-image-modal">
  <div class="order-image-modal-content">
    <button class="order-image-modal-close" onclick="closeImageModal()" title="Close">
      <i class="bi bi-x-lg"></i>
    </button>
    <img id="modalImage" src="" alt="Order Proof">
  </div>
</div>