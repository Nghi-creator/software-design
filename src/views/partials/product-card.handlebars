<div class="product-card h-100 position-relative shadow-sm rounded overflow-hidden {{#if this.is_new}}card-new{{/if}}">

    <div class="image-holder position-relative overflow-hidden" style="height: 200px;">
        <a href="/products/detail/?id={{this.id}}">
            {{#if this.thumbnail}}
            <img src="/static/{{this.thumbnail}}" alt="{{this.name}}" class="img-fluid w-100 h-100"
                style="object-fit: contain; background: #f8f9fa;">
            {{else}}
            <img src="https://placehold.co/400x300?text=No+Image" class="img-fluid w-100 h-100"
                style="object-fit: contain; background: #f8f9fa;">
            {{/if}}
        </a>

        {{!-- Badge New --}}
        {{#if this.is_new}}
        <div class="position-absolute top-0 start-0 m-2">
            <span class="badge bg-success">New</span>
        </div>
        {{/if}}

        {{!-- Badge Allows Unrated Bidders --}}
        {{#if this.allow_unrated_bidder}}
        <span class="ribbon-badge">
            Allow Unrated
        </span>
        {{/if}}

        {{!-- Watchlist Buttons (For General View) --}}
        {{#if ../isAuthenticated}}
        {{#if isWatchlistView}}
        {{!-- Watchlist Page - Always show Delete --}}
        <form action="/products/watchlist?_method=DELETE" method="POST" class="position-absolute top-0 end-0 m-2"
            style="z-index: 10;">
            <input type="hidden" name="productId" value="{{this.id}}">
            <button type="submit"
                class="btn-watchlist-submit rounded-circle shadow-sm d-flex justify-content-center align-items-center"
                style="width: 35px; height: 35px;" title="Remove from Watchlist">
                <i class="bi bi-heart-fill text-danger"></i>
            </button>
        </form>
        {{else}}
        {{!-- Product List Page - Toggle based on is_favorite --}}
        {{#if this.is_favorite}}
        <form action="/products/watchlist?_method=DELETE" method="POST" class="position-absolute top-0 end-0 m-2"
            style="z-index: 10;">
            <input type="hidden" name="productId" value="{{this.id}}">
            <button type="submit"
                class="btn-watchlist-submit rounded-circle shadow-sm d-flex justify-content-center align-items-center"
                style="width: 35px; height: 35px;" title="Remove from Watchlist">
                <i class="bi bi-heart-fill text-danger"></i>
            </button>
        </form>
        {{else}}
        <form action="/products/watchlist" method="POST" class="position-absolute top-0 end-0 m-2" style="z-index: 10;">
            <input type="hidden" name="productId" value="{{this.id}}">
            <button type="submit"
                class="btn-watchlist-submit rounded-circle shadow-sm d-flex justify-content-center align-items-center"
                style="width: 35px; height: 35px;" title="Add to Watchlist">
                <i class="bi bi-heart text-danger"></i>
            </button>
        </form>
        {{/if}}
        {{/if}}
        {{/if}}

    </div>

    <div class="card-body p-3 d-flex flex-column">
        <h5 class="card-title mb-2" style="min-height: 48px;">
            <a href="/products/detail/?id={{this.id}}" class="text-decoration-none text-dark fw-bold text-uppercase"
                style="font-size: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                {{this.name}}
            </a>
        </h5>

        <p class="card-text small text-muted mb-2">
            <i class="bi bi-calendar3"></i> Posted: {{format_date this.created_at}}
        </p>

        <hr class="my-2">

        <div class="mb-2">
            <span class="small text-muted">Current Price:</span>
            <div class="h5 text-primary fw-bold mb-0">
                {{format_number this.current_price}} VND
            </div>
        </div>

        <div class="mb-2">
            <span class="small text-muted">Buy Now:</span>
            {{#if this.buy_now_price}}
            <span class="fw-bold text-success">{{format_number this.buy_now_price}} VND</span>
            {{else}}
            <span class="text-muted fst-italic">N/A</span>
            {{/if}}
        </div>

        <div class="mb-2 d-flex justify-content-between align-items-center bg-light p-2 rounded">
            <span class="small text-muted">Highest Bidder:</span>
            {{#if this.bidder_name}}
            <span class="fw-bold text-dark">{{this.bidder_name}}</span>
            {{else}}
            <span class="small text-muted fst-italic">No bids yet</span>
            {{/if}}
        </div>

        <div class="d-flex justify-content-between mt-auto">
            <div class="text-center border-end pe-3 w-50">
                <small class="text-muted d-block">Bids</small>
                <span class="fw-bold">{{this.bid_count}}</span>
            </div>
            <div class="text-center ps-3 w-50">
                <small class="text-muted d-block">Time Left</small>
                <span class="fw-bold text-danger countdown-timer" data-end-date="{{this.end_at}}"></span>
            </div>
        </div>

        <a href="/products/detail/?id={{this.id}}" class="btn btn-outline-primary w-100 mt-3">
            View Details
        </a>
    </div>
</div>